<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Paskibra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Library Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Library untuk QR Code Scanner dan Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-image 0.3s ease-in-out;
        }
        .login-background {
            background-image: url('https://images.unsplash.com/photo-1501854140801-50d01698950b?q=80&w=2175&auto-format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        .hidden {
            display: none;
        }
        #qr-reader {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        /* Style untuk scrollbar agar lebih modern */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Container Utama -->
    <div id="app">

        <!-- ===== HALAMAN LOGIN ===== -->
        <div id="loginPage" class="min-h-screen flex flex-col items-center justify-center p-4 login-background">
            <div class="w-full max-w-md bg-white/80 backdrop-blur-sm p-8 rounded-xl shadow-lg border border-gray-200">
                <div class="text-center mb-8">
                    <div class="flex justify-center items-center gap-3">
                         <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>
                        <h1 class="text-2xl font-bold text-gray-800">Absensi Paskibra</h1>
                    </div>
                    <p class="text-gray-500 mt-2">Silakan login sebagai Admin atau Anggota.</p>
                </div>

                <!-- Form Login -->
                <div id="loginFormContainer">
                    <div class="space-y-4">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                            <input type="text" id="username" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm">
                        </div>
                        <p id="loginError" class="text-sm text-red-600 hidden">Username atau password salah!</p>
                        <button id="loginButton" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            Login
                        </button>
                    </div>
                </div>

                <div class="text-center text-xs text-gray-400 mt-6">
                    <p>Username/Password Admin: admin/admin123</p>
                    <p>Username/Password Anggota: user/user123</p>
                </div>
            </div>
        </div>

        <!-- ===== HALAMAN ANGGOTA (USER) ===== -->
        <div id="userPage" class="hidden container mx-auto p-4 md:p-8">
            <header class="bg-white p-4 rounded-xl shadow-md mb-6 flex justify-between items-center">
                <h1 class="text-xl font-bold">Dashboard Anggota Paskibra</h1>
                <button id="logoutButtonUser" class="text-sm font-medium text-white bg-red-600 hover:bg-red-700 px-4 py-2 rounded-md transition-colors">Logout</button>
            </header>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Form Absensi -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-lg font-semibold mb-4 border-b pb-2">Formulir Absensi</h2>
                     <div id="formDisabledMessage" class="hidden text-center p-6 bg-gray-50 rounded-lg">
                        <p class="font-medium text-gray-700">Pengisian absensi hanya dibuka pada hari Selasa dan Jumat.</p>
                        <p class="text-sm text-gray-500 mt-2">Silakan kembali lagi di hari latihan.</p>
                    </div>
                    <div id="formContainer">
                        <form id="attendanceForm">
                            <div class="space-y-4">
                                <div>
                                    <label for="namaAnggota" class="block text-sm font-medium">Nama Anggota</label>
                                    <input type="text" id="namaAnggota" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                                </div>
                                <div>
                                    <label for="asalKelas" class="block text-sm font-medium">Asal Kelas</label>
                                    <input type="text" id="asalKelas" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                                </div>

                                <!-- Opsi Absen -->
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <p class="text-sm font-medium text-center mb-3">Pilih Metode Absensi</p>
                                    <button type="button" id="scanQRButton" class="w-full flex items-center justify-center gap-2 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><rect x="7" y="7" width="10" height="10" rx="1"/></svg>
                                        Scan QR untuk Hadir
                                    </button>
                                    <div id="qr-reader" class="mt-4 hidden"></div>
                                    <p class="text-center text-xs text-gray-500 my-2">ATAU isi manual jika Sakit/Izin</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium">Keterangan (Manual)</label>
                                    <div class="mt-2 space-y-2">
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="keterangan" value="Sakit" class="form-radio text-red-600">
                                            <span class="ml-2">Sakit</span>
                                        </label>
                                        <label class="inline-flex items-center ml-4">
                                            <input type="radio" name="keterangan" value="Izin" class="form-radio text-red-600">
                                            <span class="ml-2">Izin</span>
                                        </label>
                                    </div>
                                </div>
                                <div id="alasanContainer" class="hidden">
                                    <label for="alasan" class="block text-sm font-medium">Alasan Sakit/Izin</label>
                                    <textarea id="alasan" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500"></textarea>
                                </div>
                                <button type="submit" id="submitManualButton" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                    Kirim Absensi Manual
                                </button>
                                <p id="userMessage" class="text-sm text-center"></p>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Riwayat Absensi Pribadi -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-lg font-semibold mb-4 border-b pb-2">Riwayat Absensiku</h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="searchNama" placeholder="Ketik nama lengkap..." class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                        <button id="searchButton" class="px-4 py-2 text-white bg-red-600 rounded-md hover:bg-red-700">Cari</button>
                    </div>
                    <div id="userPointDisplay" class="text-center p-3 bg-blue-50 rounded-lg mb-4 hidden">
                        <p class="font-semibold text-blue-800">Total Poin: <span id="userPoints">0</span></p>
                    </div>
                    <div class="overflow-auto max-h-80">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- RLS Alert for Upload - DIPERBARUI MENJADI LEBIH JELAS (MERAH) -->
            <!-- <div id="rlsAlert" class="mt-6 bg-red-50 border-l-4 border-red-500 text-red-800 p-4 rounded-xl shadow-md">
                <p class="font-bold">!! ERROR - KONFIGURASI DIPERLUKAN !!</p>
                <p class="text-sm mt-1">Error 'violates row-level security policy' berarti Supabase memblokir upload/absensi Anda. Untuk memperbaikinya, Anda **WAJIB** mengatur 'Policies' (RLS) di Dashboard Supabase:</p>
                <ul class="text-xs list-disc list-inside mt-2 ml-4 space-y-1 font-medium">
                    <li><strong>UNTUK TABEL `gallery` & `attendance`:</strong>
                        <ul class="list-disc list-inside ml-4 text-xs">
                             <li>Buat 1 Policy `SELECT` -> Roles: `anon`, `authenticated` -> Expression: `TRUE`</li>
                             <li>Buat 1 Policy `INSERT` -> Roles: `anon`, `authenticated` -> Expression: `TRUE`</li>
                        </ul>
                    </li>
                     <li><strong>UNTUK STORAGE `gallery`:</strong>
                        <ul class="list-disc list-inside ml-4 text-xs">
                             <li>Buat 1 Policy `SELECT` -> Roles: `anon`, `authenticated` -> Expression: `(bucket_id = 'gallery')`</li>
                             <li>Buat 1 Policy `INSERT` -> Roles: `anon`, `authenticated` -> Expression: `(bucket_id = 'gallery')`</li>
                        </ul>
                    </li>
                </ul>
                <p class="text-xs mt-2 font-semibold">Ini adalah masalah konfigurasi RLS, bukan bug pada kode. Harap ikuti langkah-langkah di atas di Supabase.</p>
            </div> -->
            
            <!-- Dokumentasi Section for User -->
            <div class="mt-6 bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-lg font-semibold mb-4 border-b pb-2">Dokumentasi Kegiatan</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-semibold mb-2">Upload Foto Baru</h3>
                        <div class="space-y-3">
                             <input type="file" id="userPhotoUpload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100">
                             <textarea id="userPhotoCaption" placeholder="Tambahkan keterangan singkat..." rows="2" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                             <button id="userUploadPhotoButton" class="w-full py-2 text-white bg-red-600 rounded-md hover:bg-red-700">Upload</button>
                             <p id="uploadMessage" class="text-sm text-center"></p>
                        </div>
                    </div>
                     <div>
                        <h3 class="font-semibold mb-2">Galeri</h3>
                        <div id="userGalleryContainer" class="grid grid-cols-2 sm:grid-cols-3 gap-4 max-h-96 overflow-y-auto bg-gray-50 p-4 rounded-lg">
                           <!-- Foto akan muncul di sini -->
                           <p id="userGalleryPlaceholder" class="col-span-full text-center text-gray-500">Belum ada foto yang diupload.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== HALAMAN ADMIN ===== -->
        <div id="adminPage" class="hidden container mx-auto p-4 md:p-8">
            <header class="bg-white p-4 rounded-xl shadow-md mb-6 flex justify-between items-center flex-wrap gap-4">
                <h1 class="text-xl font-bold">Dashboard Admin Paskibra</h1>
                <div class="flex items-center gap-2">
                    <!-- <button id="showQRModalButton" class="px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700">Tampilkan QR Absen</button> -->
                    <button id="logoutButtonAdmin" class="text-sm font-medium text-white bg-red-600 hover:bg-red-700 px-4 py-2 rounded-md transition-colors">Logout</button>
                </div>
            </header>
            
            <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                <div class="flex justify-between items-center mb-4 border-b pb-4 flex-wrap gap-4">
                    <h2 class="text-lg font-semibold">Rekapitulasi Kehadiran & Poin Anggota</h2>
                    <button id="downloadExcel" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">
                        Unduh Rekapan (CSV)
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="rekapTable">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Anggota</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total Poin</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Hadir</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Izin</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Sakit</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Alpha</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Kehadiran (%)</th>
                            </tr>
                        </thead>
                        <tbody id="rekapTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-lg font-semibold mb-4 border-b pb-2">Bukti Dokumentasi Kegiatan</h2>
                <div>
                    <h3 class="font-semibold mb-2">Galeri</h3>
                    <div id="adminGalleryContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-96 overflow-y-auto bg-gray-50 p-4 rounded-lg">
                       <!-- Foto akan muncul di sini -->
                       <p id="adminGalleryPlaceholder" class="col-span-full text-center text-gray-500">Belum ada foto yang diupload.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal untuk QR Code (DIHAPUS KARENA FITUR DIHILANGKAN DARI ADMIN) -->
        <!-- <div id="qrModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-40">
            <div class="bg-white p-8 rounded-lg text-center shadow-xl">
                <h2 class="text-xl font-bold mb-4">Scan QR Code Ini Untuk Absen</h2>
                <div id="qrcode" class="flex justify-center"></div>
                <p class="mt-4 text-sm text-gray-600">QR Code ini hanya berlaku untuk hari ini.</p>
                <button id="closeQRModalButton" class="mt-6 px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Tutup</button>
            </div>
        </div> -->
        
        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
        </div>
    </div>

    <!-- Script Inisialisasi Supabase dan Logika Aplikasi -->
    <script type="module">
        // === KONFIGURASI SUPABASE ===
        // !!! PERHATIAN !!! GANTI KEDUA VARIABEL INI DENGAN URL DAN ANON KEY DARI PROYEK SUPABASE ANDA
        const SUPABASE_URL = 'https://wvkikjwsdqnncvvgjhek.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2a2lrandzZHFubmN2dmdqaGVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMDAzMTYsImV4cCI6MjA3NTg3NjMxNn0.FBhcPljaoECjK2Nqi6J5R2hn3dPqJXeC4EDioDbFSfc'; 

        let supabase;
        
        /*
         * ==============================================================================
         * !!!!!! PERINGATAN KRITIS: KEBIJAKAN RLS (Row Level Security) !!!!!!
         * ==============================================================================
         * * KESALAHAN "violates row-level security policy" BERASAL DARI KONFIGURASI SUPABASE.
         * Kode ini menggunakan kunci Anonim (Anon Key) sehingga RLS HARUS diatur
         * untuk mengizinkan peran "anon" dan "authenticated".
         * * MOHON LAKUKAN LANGKAH-LANGKAH INI DI DASHBOARD SUPABASE ANDA:
         * * 1. PENGATURAN TABEL (Menu Database > Tables):
         * - Pastikan Anda **sudah membuat** tabel 'attendance' dan 'gallery' di Supabase.
         * - Pastikan RLS (Row Level Security) **diaktifkan** untuk kedua tabel tersebut.
         * * 2. KEBIJAKAN RLS TABEL (Menu Database > Policies):
         * a. TABEL 'gallery' (Untuk upload dokumentasi):
         * - Kebijakan 1 (SELECT - Melihat Foto): Allows: SELECT, Target Roles: anon, authenticated, Ekspresi: TRUE
         * - Kebijakan 2 (INSERT - Mengunggah Foto): Allows: INSERT, Target Roles: anon, authenticated, Ekspresi: TRUE
         * * b. TABEL 'attendance' (Untuk absensi):
         * - Kebijakan 1 (SELECT - Melihat Absensi): Allows: SELECT, Target Roles: anon, authenticated, Ekspresi: TRUE
         * - Kebijakan 2 (INSERT - Mengirim Absensi): Allows: INSERT, Target Roles: anon, authenticated, Ekspresi: TRUE
         * * 3. STORAGE BUCKET GALLERY (Menu Storage > Policies):
         * - Pastikan Anda memiliki bucket bernama 'gallery'.
         * - Tambahkan kebijakan di bucket 'gallery' untuk:
         * - Policy 1 (SELECT/Download): Allows: SELECT, Target Roles: anon, authenticated, Ekspresi: (bucket_id = 'gallery')
         * - Policy 2 (INSERT/Upload): Allows: INSERT, Target Roles: anon, authenticated, Ekspresi: (bucket_id = 'gallery')
         * * *Setelah semua RLS Policy ini diatur dan API Key diisi, error "violates row-level security policy" akan hilang.*
         */


        // Cek apakah URL dan Key sudah diisi
        const configErrorDiv = document.createElement('div');
        configErrorDiv.className = "p-8 bg-red-100 text-red-800 text-center";
        configErrorDiv.innerHTML = `<h1 class="text-2xl font-bold">Konfigurasi Belum Selesai</h1><p class="mt-2">Silakan edit file <strong>absensi_paskibra.html</strong> dan isi variabel <code>SUPABASE_URL</code> dan <code>SUPABASE_ANON_KEY</code> dengan kredensial dari proyek Supabase Anda. Aplikasi tidak dapat memuat data tanpa konfigurasi ini.</p><div class="text-xs text-gray-500 mt-4">Login hardcoded admin/admin123 atau user/user123 tetap bisa, tetapi data Supabase akan gagal dimuat.</div>`;

        if (SUPABASE_URL === '' || SUPABASE_ANON_KEY === '') {
            document.body.appendChild(configErrorDiv);
        } else {
            // Inisialisasi Supabase Client
            try {
                // Menggunakan window.supabase untuk mengakses fungsi createClient yang dimuat dari CDN.
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                // Menghilangkan pesan error konfigurasi jika sudah berhasil inisialisasi
                if (document.body.contains(configErrorDiv)) {
                    document.body.removeChild(configErrorDiv);
                }
            } catch (e) {
                 console.error("Gagal inisialisasi Supabase. Periksa URL dan Anon Key Anda.", e);
                 document.body.appendChild(configErrorDiv);
                 configErrorDiv.innerHTML = `<h1 class="text-2xl font-bold">Kesalahan Inisialisasi</h1><p class="mt-2">URL atau Anon Key Supabase yang Anda masukkan mungkin **Invalid**.</p><div class="text-xs text-gray-500 mt-4">Silakan cek kembali konstanta SUPABASE_URL dan SUPABASE_ANON_KEY.</div>`;
            }
        
            // === ELEMEN DOM ===
            const loadingSpinner = document.getElementById('loadingSpinner');
            const loginPage = document.getElementById('loginPage');
        const userPage = document.getElementById('userPage');
        const adminPage = document.getElementById('adminPage');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('loginButton');
        const loginError = document.getElementById('loginError');
        const logoutButtonUser = document.getElementById('logoutButtonUser');
        const logoutButtonAdmin = document.getElementById('logoutButtonAdmin');
        const attendanceForm = document.getElementById('attendanceForm');
        const formContainer = document.getElementById('formContainer');
        const formDisabledMessage = document.getElementById('formDisabledMessage');
        const namaAnggotaInput = document.getElementById('namaAnggota');
        const asalKelasInput = document.getElementById('asalKelas');
        const keteranganRadios = document.querySelectorAll('input[name="keterangan"]');
        const alasanContainer = document.getElementById('alasanContainer');
        const alasanInput = document.getElementById('alasan');
        const userMessage = document.getElementById('userMessage');
        const scanQRButton = document.getElementById('scanQRButton');
        const qrReaderDiv = document.getElementById('qr-reader');
        const searchNamaInput = document.getElementById('searchNama');
        const searchButton = document.getElementById('searchButton');
        const historyTableBody = document.getElementById('historyTableBody');
        const userPointDisplay = document.getElementById('userPointDisplay');
        const userPointsSpan = document.getElementById('userPoints');
        const rekapTableBody = document.getElementById('rekapTableBody');
        const downloadExcelButton = document.getElementById('downloadExcel');
        // const showQRModalButton = document.getElementById('showQRModalButton'); // Dihapus
        // const qrModal = document.getElementById('qrModal'); // Dihapus
        // const closeQRModalButton = document.getElementById('closeQRModalButton'); // Dihapus
        // const qrcodeContainer = document.getElementById('qrcode'); // Dihapus
        const userPhotoUpload = document.getElementById('userPhotoUpload');
        const userPhotoCaption = document.getElementById('userPhotoCaption');
        const userUploadPhotoButton = document.getElementById('userUploadPhotoButton');
        const userGalleryContainer = document.getElementById('userGalleryContainer');
        const userGalleryPlaceholder = document.getElementById('userGalleryPlaceholder');
        const adminGalleryContainer = document.getElementById('adminGalleryContainer');
        const adminGalleryPlaceholder = document.getElementById('adminGalleryPlaceholder');
        const submitManualButton = document.getElementById('submitManualButton');
        const uploadMessage = document.getElementById('uploadMessage');


        // === DATA & STATE ===
        let html5QrCode;
        const QR_SECRET_KEY = "PASKIBRA_ABSENSI_";
        const GALLERY_BUCKET_NAME = 'gallery'; // Nama bucket Anda di Supabase Storage

        // === FUNGSI UTILITAS ===
        const showLoading = (show) => loadingSpinner.classList.toggle('hidden', !show);

        function showPage(pageId) {
            loginPage.classList.add('hidden');
            userPage.classList.add('hidden');
            adminPage.classList.add('hidden');
            
            const pageElement = document.getElementById(pageId);
            if (pageElement) {
                pageElement.classList.remove('hidden');
            }

            if (pageId === 'loginPage') {
                document.body.classList.add('login-background');
                document.body.classList.remove('bg-gray-100');
            } else {
                document.body.classList.remove('login-background');
                document.body.classList.add('bg-gray-100');
            }
        }

        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function showUserMessage(message, type, targetElement = userMessage) {
            targetElement.innerHTML = message;
            targetElement.className = `text-sm text-center ${
                type === 'success' ? 'text-green-600' :
                type === 'error' ? 'text-red-600' : 'text-yellow-600'
            }`;
            setTimeout(() => { targetElement.innerHTML = ''; }, 8000); // Tampilkan error lebih lama
        }
        
        /**
         * Penanganan Error Koneksi Supabase yang Umum (TypeError: Failed to fetch)
         */
        function handleSupabaseFetchError(e, context) {
            console.error(`Error in ${context}:`, e.message);
            return "Gagal terhubung ke Supabase. Kemungkinan: **1. SUPABASE_URL atau ANON_KEY salah/kosong**; atau **2. Masalah RLS/Koneksi**.";
        }

        // === FUNGSI AUTH DAN NAVIGASI ===

        async function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value;
            showLoading(true);
            
            console.log("Attempting login for username:", username); // Log untuk debugging

            // Cek Kredensial Hardcoded
            if (username === 'admin' && password === 'admin123') {
                console.log("Login successful: Admin");
                showPage('adminPage');
                if (supabase) {
                    await renderAdminDashboard();
                    await renderGallery(adminGalleryContainer, adminGalleryPlaceholder);
                }
            } else if (username === 'user' && password === 'user123') {
                console.log("Login successful: User");
                showPage('userPage');
                checkAttendanceDay();
                 if (supabase) {
                    await renderGallery(userGalleryContainer, userGalleryPlaceholder);
                }
            } else {
                console.log("Login failed: Invalid credentials");
                loginError.textContent = "Username atau password salah!";
                loginError.classList.remove('hidden');
            }
            showLoading(false);
        }

        function handleLogout() {
             if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Gagal menghentikan QR scanner.", err));
            }
            usernameInput.value = '';
            passwordInput.value = '';
            loginError.classList.add('hidden');
            showPage('loginPage');
        }
        
        // --- Halaman Anggota ---
        function checkAttendanceDay() {
            // Hari Latihan: Selasa (2) dan Jumat (5)
            const today = new Date();
            const dayOfWeek = today.getDay(); 
            const isTrainingDay = dayOfWeek === 2 || dayOfWeek === 5;
            formContainer.classList.toggle('hidden', !isTrainingDay);
            formDisabledMessage.classList.toggle('hidden', isTrainingDay);
            submitManualButton.disabled = !isTrainingDay;
            scanQRButton.disabled = !isTrainingDay;
        }
        
        /**
         * Mengirim data absensi ke Supabase.
         */
        async function submitAttendance(nama, kelas, status, alasan = "") {
            const tanggal = getTodayDate();
            if (!supabase) return showUserMessage("Supabase belum terkonfigurasi. Cek API Key.", "error");
            
            showLoading(true);
            
            try {
                // 1. Cek apakah sudah absen hari ini
                const { data: existing, error: checkError } = await supabase
                    .from('attendance')
                    .select('id')
                    .eq('tanggal', tanggal)
                    .eq('nama', nama);

                if (checkError) throw checkError;

                if (existing.length > 0) {
                    showUserMessage('Anda sudah mengisi absensi hari ini.', 'warning');
                    showLoading(false);
                    return false;
                }

                // 2. Kirim data baru
                const { error: insertError } = await supabase
                    .from('attendance')
                    .insert([{ tanggal, nama, kelas, status, alasan: alasan || null }]);
                
                if (insertError) throw insertError;

                showLoading(false);
                showUserMessage('Absensi berhasil dikirim!', 'success');
                return true;

            } catch (e) {
                const message = handleSupabaseFetchError(e, 'submitting attendance');
                showUserMessage(`Gagal mengirim absensi. Pastikan RLS di tabel "attendance" mengizinkan INSERT. ${message}`, 'error');
                showLoading(false);
                return false;
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const nama = namaAnggotaInput.value.trim();
            const kelas = asalKelasInput.value.trim();
            const statusRadio = document.querySelector('input[name="keterangan"]:checked');
            
            if (!nama || !kelas) return showUserMessage("Nama dan Kelas wajib diisi.", "error");
            if (!statusRadio) return showUserMessage("Pilih keterangan Sakit atau Izin.", "warning");

            const status = statusRadio.value;
            const alasan = alasanInput.value.trim();
            if(await submitAttendance(nama, kelas, status, alasan)) {
                attendanceForm.reset();
                alasanContainer.classList.add('hidden');
            }
        }

        function toggleAlasanContainer() {
            const selected = document.querySelector('input[name="keterangan"]:checked');
            // Jika memilih Sakit atau Izin, tampilkan input alasan
            if (selected && (selected.value === 'Sakit' || selected.value === 'Izin')) {
                alasanContainer.classList.remove('hidden');
            } else {
                alasanContainer.classList.add('hidden');
            }
        }
        
        // --- QR Code Scanner ---
        function startQRScanner() {
            const nama = namaAnggotaInput.value.trim();
            const kelas = asalKelasInput.value.trim();
            if (!nama || !kelas) {
                showUserMessage("Mohon isi Nama dan Kelas sebelum scan QR.", 'error');
                return;
            }
            if (!supabase) return showUserMessage("Supabase belum terkonfigurasi. Cek API Key.", "error");
            
            qrReaderDiv.classList.remove('hidden');
            scanQRButton.textContent = "Tutup Scanner";
            
            html5QrCode = new Html5Qrcode("qr-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            const qrCodeSuccessCallback = async (decodedText, decodedResult) => {
                // Verifikasi QR Code
                if (decodedText === QR_SECRET_KEY + getTodayDate()) {
                    stopQRScanner();
                    
                    // Coba kirim absensi
                    const sukses = await submitAttendance(nama, kelas, "Hadir");
                    
                    if(sukses){
                         showUserMessage(`Absen Hadir untuk ${nama} berhasil via QR!`, 'success');
                         // Reset form setelah berhasil absen hadir
                         attendanceForm.reset(); 
                         alasanContainer.classList.add('hidden');
                    } else {
                        // GAGAL: Beri tahu pengguna bahwa QR valid, tapi RLS/Koneksi gagal.
                        // Pesan error spesifik (misal RLS) sudah ditampilkan oleh submitAttendance().
                        // Kita tambahkan pesan ini jika submitAttendance() gagal menampilkan error (jarang terjadi).
                        if (!userMessage.textContent.includes("Gagal")) {
                            showUserMessage("QR Code valid, tapi gagal mengirim absensi. (Cek RLS/Koneksi)", "error");
                        }
                    }
                } else {
                    showUserMessage("QR Code tidak valid atau sudah kedaluwarsa.", "error");
                }
            };
            
            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                .catch(err => console.error("Gagal memulai QR scanner.", err));
        }

        function stopQRScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                 html5QrCode.stop()
                    .then(() => {
                        qrReaderDiv.classList.add('hidden');
                        scanQRButton.textContent = "Scan QR untuk Hadir";
                    })
                    .catch(err => console.error("Gagal menghentikan QR Scanner.", err));
            } else {
                qrReaderDiv.classList.add('hidden');
                scanQRButton.textContent = "Scan QR untuk Hadir";
            }
        }

        scanQRButton.addEventListener('click', () => {
            if (html5QrCode && html5QrCode.isScanning) {
                stopQRScanner();
            } else {
                startQRScanner();
            }
        });

        // --- Riwayat & Poin Anggota (dengan Supabase) ---

        /**
         * Menghitung total poin, hadir, dan hari jadwal dari data absensi.
         */
        function calculateStats(allAttendanceData, userRecords) {
            const scheduleDays = new Set(allAttendanceData.map(r => r.tanggal));
            const totalScheduleDays = scheduleDays.size;
            
            // Filter hanya record pengguna yang dicari
            const userAttendanceDates = new Set();
            let hadir = 0;
            let sakit = 0;
            let izin = 0;
            
            userRecords.forEach(record => {
                if(record.status === 'Hadir') hadir++;
                else if(record.status === 'Sakit') sakit++;
                else if(record.status === 'Izin') izin++;
                userAttendanceDates.add(record.tanggal);
            });
            
            // Alpha adalah hari jadwal - jumlah hari absensi (Hadir/Sakit/Izin)
            const alpha = totalScheduleDays - userAttendanceDates.size;
            
            // Perhitungan Poin: Hadir +10, Alpha -5
            let points = (hadir * 10);
            points -= (alpha > 0 ? alpha * 5 : 0);

            return { points, totalScheduleDays, hadir, sakit, izin, alpha: alpha > 0 ? alpha : 0 };
        }

        async function renderUserHistory() {
            const searchName = searchNamaInput.value.trim();
            if (!searchName) {
                historyTableBody.innerHTML = '<tr><td colspan="2" class="text-center p-4 text-gray-500">Ketik nama Anda dan klik Cari.</td></tr>';
                userPointDisplay.classList.add('hidden');
                return;
            }
            if (!supabase) return showUserMessage("Supabase belum terkonfigurasi. Cek API Key.", "error");

            showLoading(true);

            try {
                // 1. Ambil semua data absensi untuk menghitung total hari jadwal
                const { data: allAttendanceData, error: allError } = await supabase
                    .from('attendance')
                    .select('tanggal, nama, status');
                if (allError) throw allError;

                // 2. Ambil riwayat absensi pengguna yang dicari
                const { data: userRecords, error: userError } = await supabase
                    .from('attendance')
                    .select('*')
                    .ilike('nama', `%${searchName}%`) // Menggunakan ilike untuk pencarian fuzzy
                    .order('created_at', { ascending: false });
                if (userError) throw userError;


                historyTableBody.innerHTML = '';
                if (userRecords.length > 0) {
                    // Temukan nama yang paling cocok (jika ada beberapa hasil)
                    const exactMatch = userRecords.find(r => r.nama.toLowerCase() === searchName.toLowerCase())
                    const recordsToCalculate = exactMatch ? userRecords.filter(r => r.nama === exactMatch.nama) : userRecords;
                    
                    const { points } = calculateStats(allAttendanceData, recordsToCalculate);
                    userPointsSpan.textContent = points;
                    userPointDisplay.classList.remove('hidden');

                    recordsToCalculate.forEach(record => {
                        const row = document.createElement('tr');
                        let statusClass = '';
                        switch(record.status) {
                            case 'Hadir': statusClass = 'bg-green-100 text-green-800'; break;
                            case 'Sakit': statusClass = 'bg-yellow-100 text-yellow-800'; break;
                            case 'Izin': statusClass = 'bg-blue-100 text-blue-800'; break;
                        }
                        row.innerHTML = `<td class="px-4 py-3">${record.tanggal}</td><td class="px-4 py-3"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${record.status}</span></td>`;
                        historyTableBody.appendChild(row);
                    });
                } else {
                    historyTableBody.innerHTML = `<tr><td colspan="2" class="text-center p-4 text-gray-500">Tidak ada data untuk nama "${searchNameInput.value}".</td></tr>`;
                     userPointDisplay.classList.add('hidden');
                }
            } catch (e) {
                const message = handleSupabaseFetchError(e, 'fetching user history');
                historyTableBody.innerHTML = `<tr><td colspan="2" class="text-center p-4 text-red-500">${message}</td></tr>`;
            }
            showLoading(false);
        }

        // --- Halaman Admin (dengan Supabase) ---
        async function renderAdminDashboard() {
            if (!supabase) return console.error("Supabase tidak terinisialisasi. Tidak dapat memuat data admin.");
            showLoading(true);

            try {
                // Ambil semua data absensi
                const { data: attendanceData, error } = await supabase
                    .from('attendance')
                    .select('tanggal, nama, kelas, status');
                if (error) throw error;
            
                const memberStats = {};
                const scheduleDays = new Set(attendanceData.map(r => r.tanggal));
                const totalScheduleDays = scheduleDays.size;

                attendanceData.forEach(record => {
                    if (!memberStats[record.nama]) {
                        memberStats[record.nama] = { kelas: record.kelas, hadir: 0, sakit: 0, izin: 0, attendedDates: new Set() };
                    }
                    memberStats[record.nama].kelas = record.kelas;
                    if(record.status === 'Hadir') memberStats[record.nama].hadir++;
                    else if(record.status === 'Sakit') memberStats[record.nama].sakit++;
                    else if(record.status === 'Izin') memberStats[record.nama].izin++;
                    memberStats[record.nama].attendedDates.add(record.tanggal);
                });
                
                rekapTableBody.innerHTML = '';
                Object.entries(memberStats).forEach(([nama, stats]) => {
                    const attendedDays = stats.attendedDates.size;
                    const alpha = totalScheduleDays - attendedDays;
                    const points = (stats.hadir * 10) - (alpha > 0 ? alpha * 5 : 0);
                    const persentase = totalScheduleDays > 0 ? ((stats.hadir / totalScheduleDays) * 100).toFixed(1) : '0.0';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 font-medium">${nama}</td>
                        <td class="px-6 py-4 text-center">${stats.kelas}</td>
                        <td class="px-6 py-4 text-center font-bold text-blue-600">${points}</td>
                        <td class="px-6 py-4 text-center">${stats.hadir}</td>
                        <td class="px-6 py-4 text-center">${stats.izin}</td>
                        <td class="px-6 py-4 text-center">${stats.sakit}</td>
                        <td class="px-6 py-4 text-center">${alpha > 0 ? alpha : 0}</td>
                        <td class="px-6 py-4 text-center font-medium ${parseFloat(persentase) >= 75 ? 'text-green-600' : 'text-red-600'}">${persentase}%</td>
                    `;
                    rekapTableBody.appendChild(row);
                });
            } catch (e) {
                // *** Perbaikan: Pesan error lebih spesifik untuk masalah tabel tidak ditemukan ***
                let message = handleSupabaseFetchError(e, 'fetching admin data');
                if (e && e.message && e.message.includes("Could not find the table")) {
                    message = "Gagal memuat data admin. **Tabel 'attendance' belum ditemukan di database Anda**. Mohon buat tabel `attendance` di Supabase.";
                }
                rekapTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-red-500">${message}</td></tr>`;
            }
            showLoading(false);
        }
        
        // --- QR Code Generator (Fungsi tidak lagi dipanggil dari admin) ---
        function generateQRCode() {
            // Dapatkan elemen qrcode container di sini jika masih diperlukan di masa depan,
            // atau hapus fungsi ini jika tidak ada bagian lain yang menggunakannya.
            const qrcodeContainer = document.getElementById('qrcode'); // Perlu didefinisikan jika modal diaktifkan lagi
            if (qrcodeContainer) {
                qrcodeContainer.innerHTML = '';
                const qr = qrcode(0, 'L');
                qr.addData(QR_SECRET_KEY + getTodayDate());
                qr.make();
                qrcodeContainer.innerHTML = qr.createImgTag(6, 8); // size 6, margin 8
            } else {
                console.error("Elemen 'qrcode' tidak ditemukan. Modal QR mungkin telah dihapus.");
            }
        }
        
        // --- Export Rekap ---
        function exportToExcel() {
            const table = document.getElementById('rekapTable');
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Header
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => `"${th.textContent}"`).join(',');
            csvContent += headers + '\r\n';
            
            // Rows
            const rows = Array.from(table.querySelectorAll('tbody tr')).map(row => 
                Array.from(row.querySelectorAll('td')).map(td => `"${td.textContent}"`).join(',')
            ).join('\r\n');
            csvContent += rows;

            const link = document.createElement('a');
            link.setAttribute('href', encodeURI(csvContent));
            link.setAttribute('download', 'rekap_absensi_paskibra.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Fitur Galeri (dengan Supabase Storage) ---
        async function renderGallery(container, placeholder) {
            if (!supabase) return;
            showLoading(true);

            // Fetch list of photos from 'gallery' table
            try {
                const { data: galleryData, error } = await supabase
                    .from('gallery')
                    .select('*');
                    // .order('created_at', { ascending: false }); // <-- DIHAPUS: Kolom 'created_at' tidak ada di database Anda.
                
                showLoading(false);
                
                if(error) throw error;

                container.innerHTML = '';
                placeholder.classList.toggle('hidden', galleryData.length > 0);

                if (galleryData.length > 0) {
                    // Jika tidak ada 'created_at', urutkan di sisi klien (walaupun Supabase mungkin tidak menjamin urutan)
                    // Atau biarkan tanpa urutan
                    
                    galleryData.forEach(photo => {
                        const galleryItem = document.createElement('div');
                        galleryItem.className = 'relative group cursor-pointer'; // Tambahkan cursor-pointer
                        galleryItem.setAttribute('data-url', photo.image_url);
                        galleryItem.onclick = () => window.open(photo.image_url, '_blank');

                        galleryItem.innerHTML = `
                            <img src="${photo.image_url}" alt="${photo.caption}" class="w-full h-24 object-cover rounded-md transition-transform duration-200 group-hover:scale-[1.03]" onerror="this.src='https://placehold.co/150x150/ef4444/ffffff?text=Error'; this.alt='Gagal memuat gambar';">
                            <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-md p-1">
                                <p class="text-white text-xs text-center line-clamp-2">${photo.caption || 'Tanpa keterangan'}</p>
                            </div>
                        `;
                        container.appendChild(galleryItem);
                    });
                } else {
                    placeholder.textContent = "Belum ada foto yang diupload.";
                }
            } catch (e) {
                // *** Perbaikan: Pesan error lebih spesifik untuk masalah tabel tidak ditemukan ***
                let message = handleSupabaseFetchError(e, 'fetching gallery');
                if (e && e.message && e.message.includes("Could not find the table")) {
                    message = "Gagal memuat galeri. **Tabel 'gallery' belum ditemukan di database Anda**. Mohon buat tabel `gallery` di Supabase.";
                }
                placeholder.textContent = message;
            }
        }

        userUploadPhotoButton.addEventListener('click', async () => {
            if (!supabase) return showUserMessage("Supabase belum terkonfigurasi. Cek API Key.", "error", uploadMessage);

            const file = userPhotoUpload.files[0];
            const caption = userPhotoCaption.value;
            if (!file) return showUserMessage("Pilih file gambar untuk diunggah.", "warning", uploadMessage);

            showLoading(true);
            // Ganti nama file untuk mencegah konflik
            const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 9)}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
            
            try {
                // 1. Upload file ke Storage
                const { error: uploadError } = await supabase.storage
                    .from(GALLERY_BUCKET_NAME) // Nama bucket Anda
                    .upload(fileName, file);

                if (uploadError) throw uploadError;

                // 2. Dapatkan URL publik dari file yang diupload
                const { data } = supabase.storage
                    .from(GALLERY_BUCKET_NAME)
                    .getPublicUrl(fileName);
                
                const publicUrl = data.publicUrl;

                // 3. Simpan URL dan caption ke tabel 'gallery'
                const { error: insertError } = await supabase
                    .from('gallery')
                    .insert([{ image_url: publicUrl, caption: caption || 'Tanpa keterangan' }]);
                
                if (insertError) throw insertError;

                // 4. Update UI
                await renderGallery(userGalleryContainer, userGalleryPlaceholder);
                // Jika admin juga login, perbarui galeri admin
                if (!adminPage.classList.contains('hidden')) {
                    await renderGallery(adminGalleryContainer, adminGalleryPlaceholder);
                }
                userPhotoUpload.value = '';
                userPhotoCaption.value = '';
                showUserMessage("Foto berhasil diunggah!", "success", uploadMessage);

            } catch (e) {
                const message = handleSupabaseFetchError(e, 'upload process');
                // Pesan error yang lebih eksplisit untuk RLS
                showUserMessage(`${message} Pastikan RLS di Storage 'gallery' dan tabel 'gallery' sudah diatur.`, "error", uploadMessage);
            } finally {
                showLoading(false);
            }
        });


        // === EVENT LISTENERS ===
        loginButton.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keyup', (e) => { if(e.key === 'Enter') handleLogin(); });
        logoutButtonUser.addEventListener('click', handleLogout);
        logoutButtonAdmin.addEventListener('click', handleLogout);
        attendanceForm.addEventListener('submit', handleFormSubmit);
        keteranganRadios.forEach(radio => radio.addEventListener('change', toggleAlasanContainer));
        searchButton.addEventListener('click', renderUserHistory);
        searchNamaInput.addEventListener('keyup', (e) => { if(e.key === 'Enter') renderUserHistory(); });
        downloadExcelButton.addEventListener('click', exportToExcel);
        // showQRModalButton.addEventListener('click', () => { // Dihapus
        //     if (!supabase) return showUserMessage("Supabase belum terkonfigurasi. Cek API Key.", "error");
        //     generateQRCode();
        //     qrModal.classList.remove('hidden');
        // });
        // closeQRModalButton.addEventListener('click', () => qrModal.classList.add('hidden')); // Dihapus

        // --- Inisialisasi Aplikasi ---
        document.addEventListener('DOMContentLoaded', async () => {
             // Tampilkan halaman login setelah DOM siap, terlepas dari status Supabase
            showPage('loginPage');
        });
        
        } // <-- Kurung kurawal penutup untuk blok Supabase Configuration (Else block)
    </script>
</body>
</html>
